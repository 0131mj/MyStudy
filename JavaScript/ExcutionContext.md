# 실행 컨텍스트

컨텍스트, 한국말로는 맥락이다. 

(세상 어떤 것이든 그렇겠지만) 자바스크립트는 전체 덩어리를 한번에 실행하는 것이 아니라 부분 부분 실행하기 때문에, 이른바 컨텍스트(맥락)에 따라 프로그램을 수행하는 환경이 달라진다. 일단 다음 코드를 보면서 무슨 말인지를 이해해보자. 

```javascript
function a(){
	console.log('a');    
}

function b(){
    console.log('b');
    a();
    console.log('b2');
}

b();


/* 출력결과
	b
	a
	b2
*/
```

코드는 총 세 부분으로 되어 있는데 function a, function b가 있고 마지막으로 실행구문 b();가 있다.  

코드 실행이 시작되면, 자바스크립트 엔진은 한줄씩 코드를 읽어내려가기 시작하는데, 

1. 첫 줄에서 function a가 선언되어 있는 걸 보고서도, 이건 그냥 선언만 된 것이기 때문에 자바스크립트 엔진은 '아 그래?' 하고 쓩 지나간다. 
2. function b 도 마찬가지로 쓩 하고 한번 더 지나간다. 
3. 마침내 b(); 를 만나면 '아 날보고 뭘 실행하라구나' 라는 걸 알고 그제서야 b를 찾는다. 
4. b를 찾아서 실행을 시작하는데 b코드블럭 내부에서 시키는 대로 콘솔에 'b'를 한번 띡 찍어주고나니 다음 줄에선 a를 실행하란다. 
5. 그래서 또 a를 찾으러 가서 이번엔 a에서 시키는대로 콘솔에 'a'를 출력한다. 
6. 그걸 다하고 다시.... b가 시키는대로 돌아와서 'b2'도 콘솔에 찍어주고나면 그제서야 비로소 b를 실행하라는 명령에 대한 소임이 끝나는 것이다. 

마치 이건 군대에서 병장이 이병보고 행정관한테 가서 뭘 확인 받아오라고 하면 이병은 행정관에게 가서 '이병 누구누구 뭐 받으러 왔습니다.' 라고 하면 행정관이 '야, 너 잘왔다 밖에 가서 애들이랑 이것 좀 같이 날라라' 라고 해서 뜬금없이 이 이병은 물품 나르는 작업에 투입이 되었다가 작업이 끝나고 나면 행정관이, '야 근데 너 뭐하러 왔더라? 아 이거 받으러 왔지' 하면서 공문 전달해주면 그제서야 이병은 받은 서류를 가지고 병장에게 돌아가서 '이병 누구누구 서류 받아 왔습니다.' 라고 하면 병장이 '너 왜 이렇게 늦게 왔냐' 라면서 혼을 내는 뭐 그런 상황이랑 비슷하다.   



당연한 얘기지만, 255줄짜리 코드가 주어졌을 때 자바스크립트 엔진은 1번줄부터 255번줄까지 코드를 한줄한줄 순서대로 실행하지 않는다. 'b'라는 함수가 호출되면 함수의 영역으로 이동해서 함수를 실행하고, 그 b함수를 실행하다가도 또 안에서 a라는 다른 함수가 나오면 a함수를 실행하는 식으로 일이 진행된다. 

이런 실행이 되는 기준을 (다른 언어는 어떤지 모르겠지만) 자바스크립트에서는 "실행 컨텍스트"라는 이름으로 명명해놓았다. 한마디로 실행 컨텍스트란, 지금 어떤 레벨에서 코드가 실행되고 있는 지를 말해주는 개념이다. 



## 실행 컨텍스트의 개념

보다 정돈된 표현으로 정의해보면 실행 컨텍스트란, 다음과 같다. 

- 실행 가능한 코드를 형상화 하고 구분하는 추상적인 개념
- 실행 가능한 자바스크립트 코드 블록이 실행되는 환경
- 현재 실행되는 컨텍스트에서 이 컨텍스트와 관련없는 실행코드가 실행되면, 새로운 컨텍스트가 생성되어 스택에 들어가고 제어권이 그 컨텍스트로 이동한다. 

실행 컨텍스트에서는 a컨텍스트에서 b컨텍스트로 '이동' 한다기보단 한줄 한줄 '쌓이는' 스택 개념으로 본다. 

쌓이긴 뭐가 쌓이냐고?  "아까 시켜놓은게 다 끝나지 않았으니, 새로 들어온 이거 먼저 처리하고 쌓인 거 나중에 처리할께" 라는 개념으로 보면 된다. 이렇게 컨텍스트가 쌓이고 치워지는 변화를, 앞에서 예를 든 것처럼 병장이 시키거나 행정관이 시킨 대로 명령의 주체가 바뀌는 것처럼, '제어권'이 이동한다고 표현한다. 



## 실행 컨텍스트의 생성과 소멸

자바스크립트에서 실행 컨텍스트가 새롭게 쌓이는 경우는 다음 3가지 경우다. 

1. 처음 코드 실행 (전역 레벨)
2. 함수안의 코드 실행
3. eval() 함수로 코드 실행


컨텍스트가 새로 들어오면 새 컨텍스트를 기존 컨텍스트 위에 하나하나씩 차곡차곡 쌓는데, 맨 위에 쌓인 컨텍스트부터 하나씩 없애나가는 방식으로 일을 처리한다. 이걸 'LIFO 방식의 스택 구조'를 지닌다고 한다.



## 실행 컨텍스트의 구조

실행컨텍스트가 어떻게 구성되어 있는지에 대한 설명이 조금씩 다른데, [포이마웹](http://poiemaweb.com/js-execution-context)에서는 실행컨텍스트 안에 변수객체와 스코프체인, this 가 들어있다고 설명해놓았고, 인사이드자바스크립트 책에서는 변수 객체 안에 스코프체인과 this가 들어있다고 설명해놓았다. 



##### 포이마 웹에서의 설명

- 실행 컨텍스트
  - 변수객체
  - 스코프체인
  - this



##### 인사이드 자바스크립트에서의 설명

- 변수객체
  - 스코프체인
  - this




포이마웹에서는 실행 컨텍스트가 단지 추상적인 개념에 머무는 것이 아니라 물리적으로 객체의 형태를 지니고 있다는 관점으로 설명하고 있고, 인사이드 자바스크립트에서는 제어권의 이동이라는 추상적인 개념으로 실행 컨텍스트를 보고 있으며 이를 변수객체의 변화로 설명하고 있는 듯 하다. 

나는 일단 인사이드 자바스크립트 책을 기준으로 나머지 설명을 이어나갈 것이며, 이후에 다른 출처의 설명들을 참조해서 비교해보고 무엇이 맞는지 추가적으로 판단해서 정리할 예정이다.



## 실행 컨텍스트 수행순서

자바스크립트의 실행 컨텍스트는 아래의 순서대로 수행된다.

1. 활성객체 생성 : 엔진 내부에서 접근가능. (사용자 접근 불가)
2. arguments 객체 생성
3. 스코프 정보 생성
4. 변수 생성
5. this 바인딩
6. 코드 실행




### 1. 활성객체 생성

- 활성객체(변수객체)는 객체 형태의 껍데기다.  여기에 컨텍스트에서 실행에 필요한 정보들(매개변수와 사용자정의 변수)이 담긴다.


### 2. arguments객체 생성

- arguments 프로퍼티로 arguments객체를 참조한다. 



### 3. 스코프 정보 생성

- 컨텍스트의 유효 범위를 나타낸다.
- 연결리스트와 유사한 형식이다.


### 4. 변수 생성

- 표현식의 실행은 변수 객체 생성이 다 이루어진 후에 시작된다. 

### 5. this 바인딩

- this가 참조하는 객체가 없는 경우, 전역객체를 참조한다. 


컨텍스트와 스코프라는 용어가 헷갈린다.

---

##### 참고링크

여기보다 아래에 설명을 잘해놓은 곳이 있으니 참조하자.

http://huns.me/development/159

http://poiemaweb.com/js-execution-context

http://heeestorys.tistory.com/708?category=693723

https://muckycode.blogspot.kr/2015/03/javascript-execution-context-scope.html

http://alnova2.tistory.com/967

http://jinbroing.tistory.com/78

http://hsp1116.tistory.com/22